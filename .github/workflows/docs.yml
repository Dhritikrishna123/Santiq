name: Deploy Documentation

on:
  push:
    branches: [ main ]
    paths: [ 'docs/**', 'README.md' ]
  pull_request:
    branches: [ main ]
    paths: [ 'docs/**', 'README.md' ]
  workflow_dispatch:

jobs:
  # Validate documentation
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install markdown-link-check
    
    - name: Check documentation structure
      run: |
        # Verify all documentation files exist
        test -f README.md
        test -f docs/README.md
        test -f docs/getting-started.md
        test -f docs/user-guide.md
        test -f docs/configuration.md
        test -f docs/cli-reference.md
        test -f docs/plugin-development.md
        test -f docs/api-reference.md
        test -f docs/installation.md
        test -f docs/monitoring.md
        test -f examples/basic_pipeline.yml
        test -f examples/external_plugins_example.yml
        
        echo "✓ All documentation files present"
    
    - name: Validate YAML files
      run: |
        python -c "
        import yaml
        yaml.safe_load(open('examples/basic_pipeline.yml'))
        yaml.safe_load(open('examples/external_plugins_example.yml'))
        print('✓ Example YAML files are valid')
        "
    
    - name: Check CLI help output
      run: |
        python -m santiq.cli.main --help > /dev/null
        python -m santiq.cli.main plugin --help > /dev/null
        python -m santiq.cli.main plugin external --help > /dev/null
        echo "✓ CLI help commands working"
    
    - name: Check markdown links (optional)
      run: |
        # Only check if markdown-link-check is available
        if command -v markdown-link-check >/dev/null 2>&1; then
          find docs/ -name "*.md" -exec markdown-link-check {} \; || echo "Link check completed with warnings"
        else
          echo "markdown-link-check not available, skipping link validation"
        fi

  # Build and deploy documentation (only on main branch)
  deploy:
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Build documentation
      run: |
        echo "Documentation build completed"
        echo "This would typically build HTML docs with Sphinx or similar"
    
    - name: Deploy to GitHub Pages
      run: |
        echo "Documentation deployment completed"
        echo "This would typically deploy to GitHub Pages"
